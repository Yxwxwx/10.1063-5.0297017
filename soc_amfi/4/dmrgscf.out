#INFO: **** input file is /home/Yxwxwx/code/dmet/test/soc_amfi/4/dmrgscf.py ****
from pyscf import gto, scf, ao2mo, mcscf, dmrgscf, lib
from pyscf.mcscf import avas
from pyscf.tools import molden, fcidump
from pyscf.lib import logger, cho_solve
from pyscf.data import nist
import numpy as np
from functools import reduce
import os
import copy
from time import time


def get_bp_hso2e(mol, dm0):
    # SOC_2e integrals are anti-symmetric towards exchange (ij|kl) -> (ji|kl)
    vj, vk, vk2 = scf.jk.get_jk(
        mol,
        [dm0, dm0, dm0],
        ["ijkl,kl->ij", "ijkl,jk->il", "ijkl,li->kj"],
        intor="int2e_p1vxp1",
        comp=3,
    )
    # hso2e = vj - 1.5 * vk - 1.5 * vk2
    return vj, vk + vk2
    # hso2e = mol.intor("int2e_p1vxp1", 3).reshape(3, mol.nao, mol.nao, mol.nao, mol.nao)
    # vj = np.einsum("yijkl,lk->yij", hso2e, dm0, optimize=True)
    # vk = np.einsum("yijkl,jk->yil", hso2e, dm0, optimize=True)
    # vk += np.einsum("yijkl,li->ykj", hso2e, dm0, optimize=True)
    # return vj, vk


def get_bp_hso2e_amfi(mol, dm0):
    """atomic-mean-field approximation"""
    ao_loc = mol.ao_loc_nr()
    nao = ao_loc[-1]
    vj = np.zeros((3, nao, nao))
    vk = np.zeros((3, nao, nao))
    import copy

    atom = copy.copy(mol)
    aoslice = mol.aoslice_by_atom(ao_loc)
    for ia in range(mol.natm):
        b0, b1, p0, p1 = aoslice[ia]
        atom._bas = mol._bas[b0:b1]
        vj1, vk1 = get_bp_hso2e(atom, dm0[p0:p1, p0:p1])
        vj[:, p0:p1, p0:p1] = vj1
        vk[:, p0:p1, p0:p1] = vk1
    return vj, vk


dmrgscf.settings.BLOCKEXE = os.popen("which block2main").read().strip()
dmrgscf.settings.MPIPREFIX = " "

start = time()

mol = gto.M(
    atom="""
                Co    3.946594   13.913238   30.684257
                P    3.512134   16.084388   28.030428
                S    3.288337   17.313925   26.593099
                N    3.366331   14.435231   27.565538
                N    3.616930   13.494506   28.544517
                N    2.390738   16.330189   29.327326
                N   2.371977   15.382532   30.351455
                N    4.986512   16.188715   28.690866
                N    5.265253   15.509610   29.883762
                C    3.807224   12.252707   28.193902
                H    3.764341   11.980779   27.304913
                C    4.072564   11.365834   29.211803
                N    4.300381   11.867388   30.500917
                C    4.659528   10.834421   31.288709
                H    4.900746   10.884186   32.184236
                N    4.605924    9.690018   30.523337
                H    4.753335    8.893610   30.811051
                C    4.276259   10.022195   29.222080
                H    4.206574    9.442795   28.497498
                C    3.409215   14.166859   26.176161
                H    3.263143   14.980862   25.688850
                H    2.724423   13.532362   25.950410
                H    4.268219   13.806067   25.947296
                C    1.468750   15.421632   31.251653
                H    0.797360   16.063238   31.222072
                N    2.512688   13.450607   32.199496
                C    1.510293   14.477886   32.283568
                C    0.763857   14.216623   33.407027
                H    0.041543   14.719599   33.709999
                N    1.271755   13.066888   34.016398
                H    0.966212   12.693477   34.728214
                C    2.347855   12.636604   33.272198
                H    2.881215   11.902579   33.473352
                C    1.313298   17.310902   29.269097
                H    1.460709   17.904522   28.528635
                H    1.295877   17.813879   30.085536
                H    0.474395   16.857691   29.154509
                C    6.273008   15.848185   30.627648
                H    6.868012   16.521781   30.387575
                N    5.432766   14.205071   32.134415
                C    6.401658   15.128378   31.815875
                C    7.243240   15.309663   32.884531
                H    7.974935   15.881953   32.925321
                N    6.794307   14.481441   33.882816
                H    7.138713   14.399685   34.665935
                C    5.684704   13.802512   33.400487
                H    5.191547   13.171571   33.871918
                C    5.971486   17.286020   28.385713
                H    5.746349   17.694799   27.547789
                H    6.855952   16.916342   28.332467
                H    5.942003   17.945398   29.082893
        """,
    basis={"default": "def2tzvp", "C": "6-31G*", "H": "6-31G*"},
    symmetry=0,
    spin=3,
    charge=+2,
    verbose=4,
    max_memory=500000,
)

mf = scf.rohf.ROHF(mol).x2c()
mf.max_cycle = 100
title = "CoSMM10"
imp_inds = mol.search_ao_label(["Co *"])
mf.chkfile = title + "_rohf.chk"
mf.init_guess = "atom"
if os.path.isfile(title + "_rohf.chk"):
    mf.init_guess = "chk"
mf.kernel()

print("nao = ", mol.nao_nr())
print("nelec = ", mol.nelec)


with open(title + "_rohf.molden", "w") as f1:
    molden.header(mol, f1)
    molden.orbital_coeff(mol, f1, mf.mo_coeff, ene=mf.mo_energy, occ=mf.mo_occ)


ao_labels = ["Co 3d"]
ncas, nelecas, mo = avas.avas(mf, ao_labels)
assert ncas == 5
# assert nelecas == 7
solver = mcscf.CASSCF(mf, ncas=ncas, nelecas=nelecas)
solver.max_cycle_micro = 100
# mo = solver.sort_mo([130, 131, 132, 133, 134, 135, 139, 140, 142, 143])
statelis = [0, 40, 0, 10]
mcfs = []
logger.info(solver, "Attempting SA-DMRGSCF with")
for i in range(len(statelis)):
    if statelis[i] != 0:
        new_mcf = dmrgscf.DMRGCI(mol, maxM=1500, tol=1e-10)
        new_mcf.spin = i
        new_mcf.nroots = statelis[i]
        new_mcf.threads = 32
        new_mcf.memory = int(mol.max_memory / 1000)
        new_mcf.block_extra_keyword = [
            "real_density_matrix",
            "davidson_soft_max_iter 1600",
            "noreorder",
            "cutoff 1E-24",
        ]
        new_mcf.runtimeDir = lib.param.TMPDIR + "/%d" % i
        new_mcf.scratchDirectory = lib.param.TMPDIR + "/%d" % i
        mcfs.append(new_mcf)
        logger.info(solver, "%s states with spin multiplicity %s", statelis[i], i + 1)
statetot = sum(statelis)
mcscf.state_average_mix_(solver, mcfs, np.ones(statetot) / statetot)
solver.kernel(mo)

mc = copy.copy(solver)

fcidump.from_integrals(
    "FCIDUMP",
    solver.get_h1eff()[0],
    solver.get_h2eff(),
    solver.ncas,
    solver.nelecas,
    nuc=solver.get_h1eff()[1],
)

mo_cas = mc.mo_coeff[:, mc.ncore : mc.ncore + mc.ncas]
sodm1 = mc.make_rdm1()

# soc integral
# breit-pauli amfi
soc_start = time()
amfi = True
hso1e = mol.intor_asymmetric("int1e_pnucxp", 3)
vj, vk = get_bp_hso2e_amfi(mol, sodm1) if amfi else get_bp_hso2e(mol, sodm1)
hso2e = vj - vk * 1.5
hsoao = 1.0j * (nist.ALPHA**2 / 2) * (hso1e + hso2e)
print("hsoao.shape = ", hsoao.shape)

hso = np.asarray([reduce(np.dot, (mo_cas.T, x.T, mo_cas)) for x in hsoao])
print("hso.shape = ", hso.shape)
# Save each component of hso (shape: 3 x nao x nao) to separate binary files as complex128
hso_labels = ["x", "y", "z"]
for i, label in enumerate(hso_labels):
    with open(f"hso_{label}.bin", "wb") as f:
        # 先写入shape信息（int32），再写入数据（complex128）
        shape = np.array(hso[i].shape, dtype=np.int32)
        f.write(shape.tobytes())
        f.write(hso[i].astype(np.complex128).tobytes())
        # print(hso[i])
soc_end = time()
print(f"soc time = {(soc_end - soc_start):.3f} s")

# np.save("sodm1.npy", sodm1)
# # x2camf
# from mycamf import x2camf

# xmol, ctr = mf.with_x2c.get_xmol(mol)
# xdmao = ctr @ sodm1 @ ctr.conj().T
# print("sodm1.shape = ", sodm1.shape)
# print("xdmao.shape = ", xdmao.shape)
# x = mf.with_x2c.get_xmat()
# r = mf.with_x2c._get_rmat(x=x)
# hso1e = xmol.intor_asymmetric("int1e_pnucxp", 3)
# hso1e = np.einsum(
#     "pq,qr,irs,sk,kl->ipl", r.conj().T, x.conj().T, hso1e, x, r, optimize=True
# )

# hso2e = x2camf.amfi(mf.with_x2c, printLevel=1)

# hso2e = hso2e / (nist.ALPHA**2 / 4)
# sphsp = xmol.sph2spinor_coeff()
# p_repr = np.einsum("ixp,pq,jyq->ijxy", sphsp, hso2e, sphsp.conj(), optimize=True)
# hso2e = (p_repr[0, np.array([1, 1, 0])] * np.array([-1j, 1, -1j])[:, None, None]).real

# s22 = xmol.intor_symmetric("int1e_ovlp")
# s21 = gto.intor_cross("int1e_ovlp", xmol, mol)
# c = cho_solve(s22, s21)
# hso1e = c.conj().T @ hso1e @ c
# hso2e = c.conj().T @ hso2e @ c
# print("hso1e.shape = ", hso1e.shape)
# print("hso2e.shape = ", hso2e.shape)
# hsoao = (1j * nist.ALPHA**2 / 2) * (hso1e + hso2e)

# hso = np.asarray([reduce(np.dot, (mo_cas.T.conj(), i.T, mo_cas)) for i in hsoao])
# print("hso.shape = ", hso.shape)
# # Save each component of hso (shape: 3 x nao x nao) to separate binary files as complex128
# hso_labels = ["x", "y", "z"]
# for i, label in enumerate(hso_labels):
#     with open(f"hso_{label}.bin", "wb") as f:
#         # 先写入shape信息（int32），再写入数据（complex128）
#         shape = np.array(hso[i].shape, dtype=np.int32)
#         f.write(shape.tobytes())
#         f.write(hso[i].astype(np.complex128).tobytes())
#         # print(hso[i])

print(f"total time elapsed: {time() - start:.2f}s")
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='cu05', release='5.15.0-133-generic', version='#144-Ubuntu SMP Fri Feb 7 20:47:38 UTC 2025', machine='x86_64')  Threads 32
Python 3.11.13 (main, Jun  5 2025, 13:12:00) [GCC 11.2.0]
numpy 2.3.1  scipy 1.16.0  h5py 3.14.0
Date: Mon Jul 28 13:11:45 2025
PySCF version 2.9.0
PySCF path  /home/Yxwxwx/.conda/envs/pyscf_311/lib/python3.11/site-packages/pyscf

[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 51
[INPUT] num. electrons = 251
[INPUT] charge = 2
[INPUT] spin (= nelec alpha-beta = 2S) = 3
[INPUT] symmetry 0 subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Co     3.946594000000  13.913238000000  30.684257000000 AA    7.457981784852  26.292209325891  57.984842065768 Bohr   0.0
[INPUT]  2 P      3.512134000000  16.084388000000  28.030428000000 AA    6.636971372773  30.395088201241  52.969832074340 Bohr   0.0
[INPUT]  3 S      3.288337000000  17.313925000000  26.593099000000 AA    6.214056335274  32.718576391260  50.253673913445 Bohr   0.0
[INPUT]  4 N      3.366331000000  14.435231000000  27.565538000000 AA    6.361443634633  27.278633134831  52.091317296291 Bohr   0.0
[INPUT]  5 N      3.616930000000  13.494506000000  28.544517000000 AA    6.835007111723  25.500920526300  53.941319487992 Bohr   0.0
[INPUT]  6 N      2.390738000000  16.330189000000  29.327326000000 AA    4.517840055590  30.859584772385  55.420614105836 Bohr   0.0
[INPUT]  7 N      2.371977000000  15.382532000000  30.351455000000 AA    4.482386903767  29.068772582358  57.355937432061 Bohr   0.0
[INPUT]  8 N      4.986512000000  16.188715000000  28.690866000000 AA    9.423141996857  30.592237658638  54.217879016595 Bohr   0.0
[INPUT]  9 N      5.265253000000  15.509610000000  29.883762000000 AA    9.949886146545  29.308915198816  56.472125751685 Bohr   0.0
[INPUT] 10 C      3.807224000000  12.252707000000  28.193902000000 AA    7.194610654871  23.154260514541  53.278753162827 Bohr   0.0
[INPUT] 11 H      3.764341000000  11.980779000000  27.304913000000 AA    7.113573529471  22.640391068940  51.598807425076 Bohr   0.0
[INPUT] 12 C      4.072564000000  11.365834000000  29.211803000000 AA    7.696030584763  21.478313437270  55.202307274748 Bohr   0.0
[INPUT] 13 N      4.300381000000  11.867388000000  30.500917000000 AA    8.126542321283  22.426113133950  57.638379678091 Bohr   0.0
[INPUT] 14 C      4.659528000000  10.834421000000  31.288709000000 AA    8.805231789742  20.474088408236  59.127090801214 Bohr   0.0
[INPUT] 15 H      4.900746000000  10.884186000000  32.184236000000 AA    9.261067746058  20.568130628825  60.819391568367 Bohr   0.0
[INPUT] 16 N      4.605924000000   9.690018000000  30.523337000000 AA    8.703934910561  18.311480162106  57.680747337803 Bohr   0.0
[INPUT] 17 H      4.753335000000   8.893610000000  30.811051000000 AA    8.982501328309  16.806487158693  58.224448000006 Bohr   0.0
[INPUT] 18 C      4.276259000000  10.022195000000  29.222080000000 AA    8.080958347706  18.939203716985  55.221727990130 Bohr   0.0
[INPUT] 19 H      4.206574000000   9.442795000000  28.497498000000 AA    7.949272782716  17.844296400412  53.852466455341 Bohr   0.0
[INPUT] 20 C      3.409215000000  14.166859000000  26.176161000000 AA    6.442482649759  26.771483555330  49.465775282521 Bohr   0.0
[INPUT] 21 H      3.263143000000  14.980862000000  25.688850000000 AA    6.166446575292  28.309726289904  48.544890955033 Bohr   0.0
[INPUT] 22 H      2.724423000000  13.532362000000  25.950410000000 AA    5.148413317466  25.572457998472  49.039167720174 Bohr   0.0
[INPUT] 23 H      4.268219000000  13.806067000000  25.947296000000 AA    8.065764949665  26.089685487396  49.033283113023 Bohr   0.0
[INPUT] 24 C      1.468750000000  15.421632000000  31.251653000000 AA    2.775535245455  29.142660873829  59.057065109942 Bohr   0.0
[INPUT] 25 H      0.797360000000  16.063238000000  31.222072000000 AA    1.506792022683  30.355120493706  59.001165121451 Bohr   0.0
[INPUT] 26 N      2.512688000000  13.450607000000  32.199496000000 AA    4.748292156481  25.417963439158  60.848228789028 Bohr   0.0
[INPUT] 27 C      1.510293000000  14.477886000000  32.283568000000 AA    2.854040137848  27.359239402675  61.007101843773 Bohr   0.0
[INPUT] 28 C      0.763857000000  14.216623000000  33.407027000000 AA    1.443480528332  26.865523886193  63.130131665950 Bohr   0.0
[INPUT] 29 H      0.041543000000  14.719599000000  33.709999000000 AA    0.078504892393  27.816010773422  63.702665769362 Bohr   0.0
[INPUT] 30 N      1.271755000000  13.066888000000  34.016398000000 AA    2.403268647546  24.692839620366  64.281675964203 Bohr   0.0
[INPUT] 31 H      0.966212000000  12.693477000000  34.728214000000 AA    1.825876058268  23.987195098466  65.626813255286 Bohr   0.0
[INPUT] 32 C      2.347855000000  12.636604000000  33.272198000000 AA    4.436802930191  23.879720704583  62.875341782301 Bohr   0.0
[INPUT] 33 H      2.881215000000  11.902579000000  33.473352000000 AA    5.444707255989  22.492614485999  63.255467751162 Bohr   0.0
[INPUT] 34 C      1.313298000000  17.310902000000  29.269097000000 AA    2.481773539939  32.712863749186  55.310577243329 Bohr   0.0
[INPUT] 35 H      1.460709000000  17.904522000000  28.528635000000 AA    2.760339957687  33.834642971250  53.911306857681 Bohr   0.0
[INPUT] 36 H      1.295877000000  17.813879000000  30.085536000000 AA    2.448852621123  33.663352526141  56.853423350743 Bohr   0.0
[INPUT] 37 H      0.474395000000  16.857691000000  29.154509000000 AA    0.896476624863  31.856419082545  55.094037306167 Bohr   0.0
[INPUT] 38 C      6.273008000000  15.848185000000  30.627648000000 AA   11.854267097206  29.948729221440  57.877866559583 Bohr   0.0
[INPUT] 39 H      6.868012000000  16.521781000000  30.387575000000 AA   12.978661700226  31.221641180043  57.424194339680 Bohr   0.0
[INPUT] 40 N      5.432766000000  14.205071000000  32.134415000000 AA   10.266439838849  26.843693770002  60.725243523115 Bohr   0.0
[INPUT] 41 C      6.401658000000  15.128378000000  31.815875000000 AA   12.097380363131  28.588491128895  60.123290163396 Bohr   0.0
[INPUT] 42 C      7.243240000000  15.309663000000  32.884531000000 AA   13.687739854495  28.931070129387  62.142757324770 Bohr   0.0
[INPUT] 43 H      7.974935000000  15.881953000000  32.925321000000 AA   15.070443011208  30.012541493214  62.219839253391 Bohr   0.0
[INPUT] 44 N      6.794307000000  14.481441000000  33.882816000000 AA   12.839379436215  27.365957379048  64.029242569031 Bohr   0.0
[INPUT] 45 H      7.138713000000  14.399685000000  34.665935000000 AA   13.490212451872  27.211460930008  65.509123001974 Bohr   0.0
[INPUT] 46 C      5.684704000000  13.802512000000  33.400487000000 AA   10.742533659220  26.082967511023  63.117772857096 Bohr   0.0
[INPUT] 47 H      5.191547000000  13.171571000000  33.871918000000 AA    9.810601992807  24.890661820264  64.008648333726 Bohr   0.0
[INPUT] 48 C      5.971486000000  17.286020000000  28.385713000000 AA   11.284473096675  32.665843583754  53.641223420506 Bohr   0.0
[INPUT] 49 H      5.746349000000  17.694799000000  27.547789000000 AA   10.859025826168  33.438323939228  52.057776547306 Bohr   0.0
[INPUT] 50 H      6.855952000000  16.916342000000  28.332467000000 AA   12.955871603164  31.967253409477  53.540603063278 Bohr   0.0
[INPUT] 51 H      5.942003000000  17.945398000000  29.082893000000 AA   11.228758301344  33.911887416318  54.958702680030 Bohr   0.0

nuclear repulsion = 4343.03076438117
number of shells = 305
number of NR pGTOs = 1259
number of NR cGTOs = 743
basis = {'default': 'def2tzvp', 'C': '6-31G*', 'H': '6-31G*'}
ecp = {}
CPU time:         5.71


******** <class 'pyscf.x2c.sfx2c1e.sfX2C1eROHF'> ********
method = sfX2C1eROHF
initial guess = chk
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
diis_damp = 0
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = CoSMM10_rohf.chk
max_memory 500000 MB (current use 100 MB)
num. doubly occ = 124  num. singly occ = 3


******** <class 'pyscf.x2c.sfx2c1e.SpinFreeX2CHelper'> ********
approx = 1e
xuncontract = 1
Set gradient conv threshold to 3.16228e-05
init E= -3363.57612702893
  HOMO = -0.317853275823868  LUMO = -0.12995041865528
cycle= 1 E= -3363.57612702  delta_E= 8.93e-09  |g|= 9.68e-05  |ddm|= 0.000184
  HOMO = -0.317853131059499  LUMO = -0.1299500579373
cycle= 2 E= -3363.57612697205  delta_E= 4.79e-08  |g|= 0.000222  |ddm|= 0.000418
  HOMO = -0.317853495427223  LUMO = -0.129950212702089
cycle= 3 E= -3363.57612703115  delta_E= -5.91e-08  |g|= 1.01e-05  |ddm|= 0.000292
  HOMO = -0.317853340758618  LUMO = -0.129950264359732
cycle= 4 E= -3363.57612703126  delta_E= -1.13e-10  |g|= 4.38e-06  |ddm|= 1.37e-05
  HOMO = -0.317853446190941  LUMO = -0.129950280329172
Extra cycle  E= -3363.57612703135  delta_E= -8.55e-11  |g|= 4.26e-06  |ddm|= 7.88e-06
converged SCF energy = -3363.57612703135
nao =  743
nelec =  (127, 124)

******** AVAS flags ********
aolabels = ['Co 3d']
ncore = 0
minao = minao
threshold = 0.2
with_iao = False
openshell_option = 2
canonicalize = True

** AVAS **
  Total number of HF MOs  is equal to    743
  Number of occupied HF MOs is equal to  127
reference AO indices for minao ['Co 3d']:
 [10 11 12 13 14]
Option 2: threshold 0.2
Active from occupied = 5 , eig [0.99684718 0.99691385 0.99748489 0.99784998 0.99905237]
Inactive from occupied = 122
Active from unoccupied = 0 , eig []
Inactive from unoccupied = 616
Dimensions of active 5
# of alpha electrons 5
# of beta electrons 2
Attempting SA-DMRGSCF with
40 states with spin multiplicity 2
10 states with spin multiplicity 4

******** <class 'pyscf.mcscf.addons.StateAverageCASSCF'> ********
CAS (5e+2e, 5o), ncore = 122, nvir = 616
max_cycle_macro = 50
max_cycle_micro = 100
conv_tol = 1e-07
conv_tol_grad = None
orbital rotation max_stepsize = 0.02
orbital rotation threshold for CI restart = 0.01
augmented hessian ah_max_cycle = 30
augmented hessian ah_conv_tol = 1e-12
augmented hessian ah_linear dependence = 1e-14
augmented hessian ah_level shift = 1e-08
augmented hessian ah_start_tol = 2.5
augmented hessian ah_start_cycle = 3
augmented hessian ah_grad_trust_region = 3
kf_trust_region = 3
kf_interval = 4
ci_response_space = 4
ci_grad_trust_region = 3
with_dep4 0
natorb = False
canonicalization = True
sorting_mo_energy = False
ao2mo_level = 2
chkfile = CoSMM10_rohf.chk
max_memory 500000 MB (current use 306371 MB)
internal_rotation = False

******** Block flags ********
executable             = /home/Yxwxwx/.conda/envs/pyscf_311/bin/block2main
BLOCKEXE_COMPRESS_NEVPT= /path/to/serially/compiled/Block/block.spin_adapted
Block version          = 2.0
mpiprefix              =  
scratchDirectory       = /tmp/1
integralFile           = /tmp/1/FCIDUMP
configFile             = /tmp/1/dmrg.conf
outputFile             = /tmp/1/dmrg.out
maxIter                = 38
scheduleSweeps         = [0, 4, 8, 12, 14, 16, 18, 20, 22, 24, 26]
scheduleMaxMs          = [200, 400, 800, 1500, 1500, 1500, 1500, 1500, 1500, 1500, 1500]
scheduleTols           = [0.0001, 0.0001, 0.0001, 0.0001, 1e-05, 1.0000000000000002e-06, 1.0000000000000002e-07, 1.0000000000000002e-08, 1.0000000000000003e-09, 1.0000000000000003e-10, 1.0000000000000001e-11]
scheduleNoises         = [0.0001, 0.0001, 0.0001, 0.0001, 1e-05, 1.0000000000000002e-06, 1.0000000000000002e-07, 1.0000000000000002e-08, 1.0000000000000003e-09, 1.0000000000000003e-10, 0.0]
twodot_to_onedot       = 30
tol                    = 1e-10
maxM                   = 1500
dmrg switch tol        = 0.001
wfnsym                 = 1
fullrestart            = False
num_thrds              = 32
memory                 = 500

State-average over 50 states with weights [0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02
 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02
 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02
 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02]
CASCI E = -3363.29549241374  S^2 = 1.3500000
Set conv_tol_grad to 0.000316228
macro iter   1 ( 42 JK   13 micro), CASSCF E = -3363.41756071593  dE = -1.22068302e-01  S^2 = 1.3500000
               |grad[o]|= 0.39  |ddm|=4.98e-15  |maxRot[o]|=0.155
macro iter   2 ( 17 JK    7 micro), CASSCF E = -3363.42777446991  dE = -1.02137540e-02  S^2 = 1.3500000
               |grad[o]|=0.0734  |ddm|=2.63e-15  |maxRot[o]|=0.0704
macro iter   3 ( 11 JK    4 micro), CASSCF E = -3363.42781223492  dE = -3.77650144e-05  S^2 = 1.3500000
               |grad[o]|=0.00369  |ddm|=3.04e-15  |maxRot[o]|=0.00468
macro iter   4 (  1 JK    1 micro), CASSCF E = -3363.42781223492  dE = -9.09494702e-13  S^2 = 1.3500000
               |grad[o]|=2.67e-05  |ddm|=3.03e-15  |maxRot[o]|=    0
1-step CASSCF converged in   4 macro ( 71 JK  25 micro) steps
CASSCF canonicalization
Density matrix diagonal elements [1.4 1.4 1.4 1.4 1.4]
CASSCF energy = -3363.42781223492
CASCI E = -3363.42781223492  E(CI) = -23.6311711631715  S^2 = 1.3500000
CASCI state-averaged energy = -3363.42781223492
CASCI energy for each state
  State 0 weight 0.02  E = -3363.49393508944 S^2 = 0.7500000
  State 1 weight 0.02  E = -3363.49255817536 S^2 = 0.7500000
  State 2 weight 0.02  E = -3363.48023785044 S^2 = 0.7500000
  State 3 weight 0.02  E = -3363.4798052904 S^2 = 0.7500000
  State 4 weight 0.02  E = -3363.47930971245 S^2 = 0.7500000
  State 5 weight 0.02  E = -3363.47690775169 S^2 = 0.7500000
  State 6 weight 0.02  E = -3363.47634749813 S^2 = 0.7500000
  State 7 weight 0.02  E = -3363.46766148803 S^2 = 0.7500000
  State 8 weight 0.02  E = -3363.45844647259 S^2 = 0.7500000
  State 9 weight 0.02  E = -3363.45424860038 S^2 = 0.7500000
  State 10 weight 0.02  E = -3363.45328347175 S^2 = 0.7500000
  State 11 weight 0.02  E = -3363.45230399258 S^2 = 0.7500000
  State 12 weight 0.02  E = -3363.44381988545 S^2 = 0.7500000
  State 13 weight 0.02  E = -3363.44358728063 S^2 = 0.7500000
  State 14 weight 0.02  E = -3363.4383956024 S^2 = 0.7500000
  State 15 weight 0.02  E = -3363.43492257027 S^2 = 0.7500000
  State 16 weight 0.02  E = -3363.43450424839 S^2 = 0.7500000
  State 17 weight 0.02  E = -3363.4324068131 S^2 = 0.7500000
  State 18 weight 0.02  E = -3363.43061899252 S^2 = 0.7500000
  State 19 weight 0.02  E = -3363.42996998468 S^2 = 0.7500000
  State 20 weight 0.02  E = -3363.42402853551 S^2 = 0.7500000
  State 21 weight 0.02  E = -3363.42358399539 S^2 = 0.7500000
  State 22 weight 0.02  E = -3363.42273707383 S^2 = 0.7500000
  State 23 weight 0.02  E = -3363.41294534806 S^2 = 0.7500000
  State 24 weight 0.02  E = -3363.40974387331 S^2 = 0.7500000
  State 25 weight 0.02  E = -3363.40963550408 S^2 = 0.7500000
  State 26 weight 0.02  E = -3363.40641038236 S^2 = 0.7500000
  State 27 weight 0.02  E = -3363.40587833407 S^2 = 0.7500000
  State 28 weight 0.02  E = -3363.36110025227 S^2 = 0.7500000
  State 29 weight 0.02  E = -3363.36094218783 S^2 = 0.7500000
  State 30 weight 0.02  E = -3363.35621103985 S^2 = 0.7500000
  State 31 weight 0.02  E = -3363.35574198453 S^2 = 0.7500000
  State 32 weight 0.02  E = -3363.35300178098 S^2 = 0.7500000
  State 33 weight 0.02  E = -3363.35116082089 S^2 = 0.7500000
  State 34 weight 0.02  E = -3363.34675477226 S^2 = 0.7500000
  State 35 weight 0.02  E = -3363.2534882985 S^2 = 0.7500000
  State 36 weight 0.02  E = -3363.24781816959 S^2 = 0.7500000
  State 37 weight 0.02  E = -3363.24599484881 S^2 = 0.7500000
  State 38 weight 0.02  E = -3363.23691775008 S^2 = 0.7500000
  State 39 weight 0.02  E = -3363.23651790297 S^2 = 0.7500000
  State 40 weight 0.02  E = -3363.57156269896 S^2 = 3.7500000
  State 41 weight 0.02  E = -3363.57062996696 S^2 = 3.7500000
  State 42 weight 0.02  E = -3363.54894719507 S^2 = 3.7500000
  State 43 weight 0.02  E = -3363.54090695143 S^2 = 3.7500000
  State 44 weight 0.02  E = -3363.53980743161 S^2 = 3.7500000
  State 45 weight 0.02  E = -3363.53822106481 S^2 = 3.7500000
  State 46 weight 0.02  E = -3363.51963922318 S^2 = 3.7500000
  State 47 weight 0.02  E = -3363.46565508992 S^2 = 3.7500000
  State 48 weight 0.02  E = -3363.46147143915 S^2 = 3.7500000
  State 49 weight 0.02  E = -3363.45988705912 S^2 = 3.7500000
hsoao.shape =  (3, 743, 743)
hso.shape =  (3, 5, 5)
soc time = 6.647 s
total time elapsed: 1419.89s
